<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ระบบลงเวลาทำงาน</title>
  
  <!-- Bootstrap 5 CSS (Includes Bootstrap Icons) --><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts --><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; touch-action: manipulation; }
    
    .main-card {  border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
    .card-header-custom { background: #0d6efd; color: white; padding: 20px; text-align: center; }
    .profile-img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid #fff; object-fit: cover; margin-top: -105px; background: #fff; }
    
    /* Signature Wrapper */
    .signature-container {
      background-color: #fff;
      border: 2px dashed #adb5bd;
      border-radius: 10px;
      position: relative;
      height: 220px;
      width: 100%;
      overflow: hidden;
    }
    
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    .hidden { display: none !important; }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
  </style>
</head>
<body>

  <!-- Loading --><div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary mb-2" role="status"></div>
    <span id="loading-text" class="text-muted small">กำลังเชื่อมต่อ...</span>
  </div>

  <div class="container py-4" style="max-width: 450px;">
    <div class="card main-card">
      <div class="card-header-custom" style="height: 100px;"></div>
      
      <div class="card-body text-center px-4 pb-4">
        <img id="user-pic" src="https://via.placeholder.com/90" class="profile-img mb-2 hidden">
        <h5 id="user-name" class="fw-bold mb-1">User</h5>
        <p id="date-display" class="text-muted small mb-3">...</p>

        <hr class="my-4">

        <!-- Alert Message --><div id="alert-area" class="hidden">
          <div id="alert-box" class="alert alert-secondary border-0"></div>
        </div>

        <!-- Form Area --><div id="form-area" class="hidden text-start">
          
          <!-- Signature Pad --><div class="mb-3">
            <label class="form-label small fw-bold text-muted">เซ็นชื่อที่นี่</label>
            <div class="signature-container">
              <canvas id="signature-canvas"></canvas>
            </div>
            <button class="btn btn-sm btn-light border w-100 mt-1 text-muted" onclick="resetSignature()">
              <i class="bi bi-arrow-counterclockwise me-1"></i> ล้างลายเซ็น
            </button>
          </div>

          <!-- Buttons --><div class="d-grid gap-2 mt-4">
            <button id="btn-in" class="btn btn-primary py-2 hidden" onclick="submitData('เข้างาน')"><i class="bi bi-box-arrow-in-right me-2"></i> ลงเวลาเข้างาน</button>
            <button id="btn-out" class="btn btn-warning text-white py-2 hidden" onclick="submitData('ออกงาน')"><i class="bi bi-box-arrow-right me-2"></i> ลงเวลาออกงาน</button>
          </div>
        </div>

      </div>
    </div>
   
   <div class="text-center mt-3">
        <a href="report.html" class="btn btn-outline-secondary btn-sm"><i class="bi bi-bar-chart-line me-1"></i> ดูรายงานลงเวลา</a>
    </div>
  </div>

  <!-- Libraries --><script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // ================= CONFIG =================
    const LIFF_ID = '2008523830-oyWp2332'; 
    const API_URL = 'https://script.google.com/macros/s/AKfycbxP8XwyDo4NuUUmLkKsRmIrhOv8hnXQX6zXJu0E_1r9Q-iwJttjI-Ir7Xlh78-cjKvj/exec'; 
    // ==========================================

    let signaturePad = null;
    let userProfile = null;

    window.onload = async () => {
      // 1. Set Date
      const d = new Date();
      const opts = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
      document.getElementById('date-display').innerText = d.toLocaleDateString('th-TH', opts);

      // 2. Init LIFF
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }
        userProfile = await liff.getProfile();
        document.getElementById('user-name').innerText = userProfile.displayName;
        document.getElementById('user-pic').src = userProfile.pictureUrl;
        document.getElementById('user-pic').classList.remove('hidden');

        // 3. Check Status
        checkStatus();

      } catch (err) {
        showError('LIFF Init Failed: ' + err);
      }
    };

    // --- Signature Management (Lazy Init) ---
    function initSignaturePad() {
      const canvas = document.getElementById('signature-canvas');
      const container = canvas.parentElement;

      if (signaturePad) {
        signaturePad.off();
        signaturePad = null;
      }

      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = container.offsetWidth * ratio;
      canvas.height = container.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);

      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)'
      });
    }

    function resetSignature() {
      if (signaturePad) signaturePad.clear();
    }

    async function checkStatus() {
      setLoading(true, "ตรวจสอบข้อมูล...");
      try {
        const res = await fetch(`${API_URL}?action=getConfig&userId=${userProfile.userId}`);
        const data = await res.json();
        setLoading(false);
        renderUI(data);
      } catch (err) {
        showError("Connection Error: " + err);
      }
    }

    function renderUI(data) {
      document.getElementById('alert-area').classList.add('hidden');
      document.getElementById('form-area').classList.add('hidden');
      document.getElementById('btn-in').classList.add('hidden');
      document.getElementById('btn-out').classList.add('hidden');

      if (data.mode === 'none') {
        const alertBox = document.getElementById('alert-box');
        alertBox.innerHTML = `<i class="bi bi-info-circle me-2"></i>${data.message}`;
        alertBox.className = data.message.includes('เรียบร้อย') ? 'alert alert-success border-0' : 'alert alert-secondary border-0';
        document.getElementById('alert-area').classList.remove('hidden');
      } else {
        document.getElementById('form-area').classList.remove('hidden');
        if (data.mode === 'in') document.getElementById('btn-in').classList.remove('hidden');
        if (data.mode === 'out') document.getElementById('btn-out').classList.remove('hidden');

        setTimeout(() => {
           initSignaturePad();
        }, 100);
      }
    }

    async function submitData(type) {
      if (!signaturePad || signaturePad.isEmpty()) {
        return Swal.fire('แจ้งเตือน', 'กรุณาเซ็นชื่อก่อนครับ', 'warning');
      }
      
      setLoading(true, "กำลังบันทึก...");
      
      const payload = {
        action: 'saveAttendance',
        userId: userProfile.userId,
        displayName: userProfile.displayName,
        type: type,
        signature: signaturePad.toDataURL()
      };

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        
        setLoading(false);

        if (result.success) {
          await Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
          resetSignature();
          checkStatus(); 
        } else {
          Swal.fire('ผิดพลาด', result.message, 'error');
        }

      } catch (err) {
        showError("บันทึกไม่สำเร็จ: " + err);
      }
    }

    function setLoading(show, text) {
      const el = document.getElementById('loading');
      document.getElementById('loading-text').innerText = text;
      if (show) el.classList.remove('hidden');
      else el.classList.add('hidden');
    }

    function showError(msg) {
      setLoading(false);
      Swal.fire('Error', msg, 'error');
    }
  </script>
</body>
</html>
