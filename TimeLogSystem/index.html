<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        html, body { height: 100%; margin: 0; background-color: #f4f7f6; }
        body { display: flex; align-items: center; justify-content: center; text-align: center; }
        .app-container { max-width: 400px; width: 100%; padding: 20px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .profile-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 3px solid #06C755; }
        .btn-lg-custom { padding: 0.75rem 1.25rem; font-size: 1.1rem; font-weight: 500; }
        
        #action-area { display: none; }
        .status-message { font-size: 0.95rem; color: #6c757d; margin-bottom: 15px; }

        /* Styles for History Table */
        .history-table { font-size: 0.85rem; text-align: left; }
        .history-table th { white-space: nowrap; }
        .action-in { color: #198754; font-weight: 600; }
        .action-out { color: #dc3545; font-weight: 600; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- Loading -->
        <div id="loading-spinner">
            <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>
            <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <img id="profile-picture" src="https://placehold.co/80x80/EFEFEF/AAAAAA?text=User" class="profile-img">
            <h5 id="display-name">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</h5>
            
            <div id="location-status" class="alert alert-warning my-3 p-2" style="font-size: 0.9rem;">
                <div class="spinner-border spinner-border-sm me-1"></div> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...
            </div>

            <!-- Area ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
            <div id="action-area">
                <!-- Case 1: ‡∏õ‡∏∏‡πà‡∏° Check In -->
                <div id="zone-check-in" style="display: none;">
                    <p class="status-message">‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                    <button onclick="recordTime('IN')" class="btn btn-success btn-lg-custom w-100">
                        Check In (‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô)
                    </button>
                </div>

                <!-- Case 2: ‡∏õ‡∏∏‡πà‡∏° Check Out -->
                <div id="zone-check-out" style="display: none;">
                    <p class="status-message">‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                    <button onclick="recordTime('OUT')" class="btn btn-danger btn-lg-custom w-100">
                        Check Out (‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô)
                    </button>
                </div>

                <!-- Case 3: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤ / ‡∏à‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß) -->
                <div id="zone-message" class="alert alert-secondary" style="display: none;">
                    <h5 class="alert-heading h6" id="msg-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h5>
                    <p id="msg-body" class="mb-0 small"></p>
                </div>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-outline-secondary btn-sm" onclick="fetchHistory()" data-bs-toggle="modal" data-bs-target="#historyModal">
                    üïí ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                </button>
                <button class="btn btn-link btn-sm text-muted text-decoration-none" onclick="window.location.reload()">
                    ‚Üª ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                </button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fs-6">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="history-loading" class="text-center my-3">
                        <div class="spinner-border text-secondary spinner-border-sm"></div>
                    </div>
                    <div id="history-error" class="alert alert-danger small p-2" style="display:none;"></div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm history-table" id="history-table" style="display:none;">
                            <thead class="table-light">
                                <tr>
                                    <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                    <th>Map</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- START: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ---
        // ‚ùóÔ∏è‚ùóÔ∏è 1. ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Google Apps Script 
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzsD37DUtXNTRl27jy0BEiKXmmgCIqCfDmEJZJq1jUqQsn4GYV0FRd-VbiqEw7SeRt_/exec';

        // ‚ùóÔ∏è‚ùóÔ∏è 2. ‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å LINE Developers Console
        const LIFF_ID = '2008523830-4dl82dd2';
        // --- END: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ---

        let userProfile = {};
        let userLocation = {};

        // Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainContent = document.getElementById('main-content');
        const actionArea = document.getElementById('action-area');
        const locationStatus = document.getElementById('location-status');
        
        // Zones
        const zoneCheckIn = document.getElementById('zone-check-in');
        const zoneCheckOut = document.getElementById('zone-check-out');
        const zoneMessage = document.getElementById('zone-message');
        const msgBody = document.getElementById('msg-body');

        // Init
        window.onload = async () => {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }

            userProfile = await liff.getProfile();
            document.getElementById('display-name').textContent = userProfile.displayName;
            document.getElementById('profile-picture').src = userProfile.pictureUrl;

            // Start processes parallelly
            getLocation(); 
            checkUserStatus();
        };

        async function checkUserStatus() {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'getStatus', userId: userProfile.userId })
                });
                const data = await response.json();

                loadingSpinner.style.display = 'none';
                mainContent.style.display = 'block';
                actionArea.style.display = 'block';

                // Hide all zones first
                zoneCheckIn.style.display = 'none';
                zoneCheckOut.style.display = 'none';
                zoneMessage.style.display = 'none';

                // Logic display
                if (data.uiState === 'CAN_CHECK_IN') {
                    zoneCheckIn.style.display = 'block';
                } else if (data.uiState === 'CAN_CHECK_OUT') {
                    zoneCheckOut.style.display = 'block';
                } else if (data.uiState === 'COMPLETED') {
                    showMessage('‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß', data.message, 'success');
                } else if (data.uiState === 'WAITING_FOR_CHECKOUT') {
                    showMessage('‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô', data.message, 'warning');
                } else if (data.uiState === 'CANNOT_CHECK_IN') {
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ', data.message, 'secondary');
                }

            } catch (error) {
                showMessage('Error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + error.message, 'danger');
            }
        }

        function showMessage(title, body, type) {
            zoneMessage.className = `alert alert-${type}`;
            zoneMessage.style.display = 'block';
            document.getElementById('msg-title').textContent = title;
            msgBody.innerHTML = body;
        }

        async function recordTime(action) {
            if (!userLocation.latitude) {
                alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ "${action === 'IN' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô'}"?`)) return;

            loadingSpinner.style.display = 'block';
            mainContent.style.display = 'none';

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: action,
                        userId: userProfile.userId,
                        displayName: userProfile.displayName,
                        latitude: userLocation.latitude,
                        longitude: userLocation.longitude
                    })
                });
                const result = await response.json();

                if (result.status === 'success') {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    location.reload();
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.message);
                    location.reload();
                }
            } catch (e) {
                alert('Error: ' + e.message);
                location.reload();
            }
        }

        // History Logic
        async function fetchHistory() {
            const tableBody = document.getElementById('history-table-body');
            const loading = document.getElementById('history-loading');
            const table = document.getElementById('history-table');
            const errDiv = document.getElementById('history-error');

            // Reset
            tableBody.innerHTML = '';
            loading.style.display = 'block';
            table.style.display = 'none';
            errDiv.style.display = 'none';

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getHistory', userId: userProfile.userId })
                });
                const result = await response.json();

                loading.style.display = 'none';
                if (result.status === 'success' && result.history.length > 0) {
                    table.style.display = 'table';
                    result.history.forEach(item => {
                        const dateObj = new Date(item.timestamp);
                        const dateStr = dateObj.toLocaleDateString('th-TH', {day:'numeric', month:'short'});
                        const timeStr = dateObj.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                        
                        const actionClass = item.action === 'IN' ? 'action-in' : 'action-out';
                        
                        const tr = `<tr>
                            <td>${dateStr}<br><span class="text-muted">${timeStr}</span></td>
                            <td class="${actionClass}">${item.action}</td>
                            <td><a href="${item.locationLink}" target="_blank" class="btn btn-light btn-sm py-0 px-1">üìç</a></td>
                        </tr>`;
                        tableBody.innerHTML += tr;
                    });
                } else {
                    errDiv.style.display = 'block';
                    errDiv.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
                }
            } catch (e) {
                loading.style.display = 'none';
                errDiv.style.display = 'block';
                errDiv.textContent = 'Error: ' + e.message;
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
                        locationStatus.className = 'alert alert-success my-3 p-1 small';
                        locationStatus.innerHTML = '‚úÖ ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    },
                    (err) => {
                        locationStatus.className = 'alert alert-danger my-3 p-1 small';
                        locationStatus.innerHTML = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS)';
                    }
                );
            } else {
                locationStatus.innerHTML = 'Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS';
            }
        }
    </script>
</body>
</html>
